<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VANTAGE | Global Risk Command</title>
    <meta name="description" content="Real-time geopolitical risk intelligence and supply chain monitoring.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 2. VANTAGE ENTERPRISE THEME --- */
        :root {
            --bg-body: #050505;       /* Void Black */
            --bg-panel: #0f1115;      /* Panel Grey */
            --bg-card: #16191f;       /* Card Grey */
            --border: #2a2f3a;        /* Subtle Border */
            
            --accent: #00f2ff;        /* Cyan (System OK) */
            --alert: #ff2a6d;         /* Red (Critical) */
            --warn: #ffcc00;          /* Yellow (Warning) */
            --text-main: #e2e8f0;     
            --text-muted: #94a3b8;

            --font-head: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- 3. NAVIGATION (The Sales Funnel) --- */
        .navbar {
            height: 60px;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            z-index: 1000;
        }

        .brand {
            font-family: var(--font-head);
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #fff;
            display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: var(--accent); }

        .nav-actions { display: flex; gap: 15px; align-items: center; }

        .live-badge {
            font-size: 11px; font-weight: 600; color: var(--accent);
            border: 1px solid rgba(0, 242, 255, 0.3);
            padding: 4px 10px; border-radius: 4px;
            animation: pulse 2s infinite;
        }

        /* The "Money Button" */
        .core-btn {
            background: #fff; color: #000;
            font-family: var(--font-head); font-weight: 700; font-size: 13px;
            padding: 8px 16px; border-radius: 2px;
            text-decoration: none; text-transform: uppercase;
            transition: all 0.2s;
        }
        .core-btn:hover { background: var(--accent); box-shadow: 0 0 15px var(--accent); }

        /* --- 4. DASHBOARD LAYOUT --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: 400px 1fr; /* Sidebar Fixed | Map Flexible */
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* SIDEBAR (Intelligence Feed) */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); padding: 10px; border-radius: 4px; border-left: 2px solid var(--border); }
        .stat-val { font-family: var(--font-head); font-size: 24px; font-weight: 700; display: block; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }

        /* Filters & Search */
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .search-box {
            background: #000; border: 1px solid var(--border);
            color: #fff; padding: 10px; width: 100%;
            font-family: var(--font-body); font-size: 13px;
            border-radius: 4px; outline: none;
        }
        .search-box:focus { border-color: var(--accent); }

        .filter-tags { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-muted); font-size: 11px; padding: 4px 8px;
            cursor: pointer; border-radius: 3px; transition: 0.2s;
        }
        .filter-btn:hover, .filter-btn.active { background: var(--bg-card); color: #fff; border-color: var(--text-muted); }

        /* Feed List */
        .feed-list {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        /* Custom Scrollbar */
        .feed-list::-webkit-scrollbar { width: 6px; }
        .feed-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Cards */
        .intel-card {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 15px; border-radius: 6px; transition: transform 0.2s;
            position: relative;
        }
        .intel-card:hover { transform: translateX(5px); border-color: #444; }
        
        .card-meta { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 10px; color: var(--text-muted); }
        .risk-badge { font-weight: 700; padding: 2px 6px; border-radius: 2px; }
        
        .card-title { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px; line-height: 1.4; display: block; text-decoration: none; }
        .card-title:hover { color: var(--accent); }
        .card-snippet { font-size: 12px; color: #aaa; line-height: 1.5; }

        /* --- 5. MAP AREA --- */
        .map-wrapper { position: relative; height: 100%; width: 100%; background: #000; }
        #riskMap { width: 100%; height: 100%; z-index: 1; }

        .map-overlay-title {
            position: absolute; top: 20px; left: 20px; z-index: 500;
            background: rgba(5,5,5,0.9); border: 1px solid var(--border);
            padding: 10px 15px; border-radius: 4px; pointer-events: none;
        }
        .map-h1 { margin: 0; font-family: var(--font-head); font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; }

        /* Locked Feature Overlay (The Upsell) */
        .locked-feature {
            position: absolute; bottom: 80px; right: 20px; z-index: 500;
            background: rgba(5,5,5,0.95); border: 1px solid var(--alert);
            padding: 15px; border-radius: 4px; width: 250px;
            box-shadow: 0 0 20px rgba(255, 42, 109, 0.1);
        }
        .lock-icon { font-size: 12px; color: var(--alert); font-weight: 700; margin-bottom: 5px; display: block; }
        .lock-text { font-size: 11px; color: #ccc; margin-bottom: 10px; line-height: 1.4; }
        .lock-link { color: #fff; font-size: 11px; font-weight: 700; text-decoration: underline; cursor: pointer;}

        /* --- 6. TICKER --- */
        .ticker-wrap {
            position: fixed; bottom: 0; width: 100%; height: 30px;
            background: var(--accent); color: #000;
            overflow: hidden; z-index: 2000;
            display: flex; align-items: center;
        }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 40s linear infinite; padding-left: 100%; }
        .ticker-item { display: inline-block; padding: 0 30px; font-family: var(--font-head); font-weight: 700; font-size: 12px; text-transform: uppercase; }
        
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .dashboard-container { grid-template-columns: 1fr; display: flex; flex-direction: column-reverse; }
            .map-wrapper { height: 400px; }
            .sidebar { height: auto; border-top: 1px solid var(--border); }
            .feed-list { max-height: 500px; }
            .brand { font-size: 16px; }
            .core-btn { font-size: 10px; padding: 6px 12px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            VANTAGE <span>// COMMAND</span>
        </div>
        <div class="nav-actions">
            <span id="last-updated" class="live-badge">CONNECTING...</span>
            <a href="https://avellon.ai/solutions" target="_blank" class="core-btn">Access Avellon Core</a>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="stats-row">
                    <div class="stat-card" style="border-color: var(--alert);">
                        <span class="stat-val" id="stat-high-risk">0</span>
                        <span class="stat-label">Critical Alerts</span>
                    </div>
                    <div class="stat-card" style="border-color: var(--accent);">
                        <span class="stat-val" id="stat-total">0</span>
                        <span class="stat-label">Signals Scanned</span>
                    </div>
                </div>

                <div style="height: 100px; margin-bottom: 20px;">
                    <canvas id="miniChart"></canvas>
                </div>

                <div class="controls">
                    <input type="text" id="searchInput" class="search-box" placeholder="Filter signals (e.g. 'Strait', 'Cyber')..." onkeyup="handleSearch()">
                    <div class="filter-tags">
                        <button class="filter-btn active" onclick="filterData('ALL')">ALL</button>
                        <button class="filter-btn" onclick="filterData('GEOPOLITICS')">GEO</button>
                        <button class="filter-btn" onclick="filterData('GLOBAL ECONOMY')">ECO</button>
                        <button class="filter-btn" onclick="filterData('CYBER & TECH')">CYBER</button>
                    </div>
                </div>
            </div>

            <div id="feed-list" class="feed-list">
                <div style="text-align:center; color: #666; font-size: 12px; margin-top: 50px;">
                    Initializing Secure Uplink...
                </div>
            </div>
        </aside>

        <main class="map-wrapper">
            <div class="map-overlay-title">
                <h1 class="map-h1">Global Chokepoint Monitor</h1>
            </div>
            
            <div id="riskMap"></div>

            <div class="locked-feature">
                <span class="lock-icon">ðŸ”’ RESTRICTED FEATURE</span>
                <div class="lock-text">Supply Chain Impact Simulation is locked. Enterprise license required.</div>
                <a class="lock-link" href="https://avellon.ai" target="_blank">UPGRADE TO CORE ></a>
            </div>
        </main>
    </div>

    <div class="ticker-wrap">
        <div class="ticker" id="ticker-content">
            <div class="ticker-item">/// SYSTEM INITIALIZING /// VANTAGE INTELLIGENCE /// ESTABLISHING SATELLITE LINK ///</div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let map;
        let allRiskItems = [];
        const chokepointCoords = {
            "Strait of Hormuz": [26.5667, 56.2500],
            "Bab el-Mandeb (Red Sea)": [12.5833, 43.3333],
            "Malacca Strait": [4.1667, 99.5000],
            "Panama Canal": [9.1000, -79.7000],
            "Taiwan Strait": [24.0000, 119.0000],
            "Turkish Straits": [40.7000, 28.5000],
            "Cape of Good Hope": [-34.3548, 18.4698],
            "Suez Canal": [30.5852, 32.2654]
        };

        // --- 1. INITIALIZE MAP (Dark Mode) ---
        function initMap() {
            map = L.map('riskMap', { zoomControl: false }).setView([25, 0], 2);
            
            // CartoDB Dark Matter Tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; VANTAGE INTELLIGENCE',
                maxZoom: 19
            }).addTo(map);

            // Move zoom control to top right
            L.control.zoom({ position: 'topright' }).addTo(map);
        }

        // --- 2. FETCH DATA ---
        document.addEventListener("DOMContentLoaded", () => {
            initMap();
            
            // Fetch the JSON generated by Python
            fetch('outputs/dashboard_data.json')
                .then(r => {
                    if (!r.ok) throw new Error("HTTP error " + r.status);
                    return r.json();
                })
                .then(data => {
                    // Update UI
                    document.getElementById('last-updated').innerText = "LIVE: " + data.generated_at;
                    document.getElementById('last-updated').style.animation = "none";
                    document.getElementById('last-updated').style.color = "#fff";

                    // Flatten Items
                    Object.keys(data.items).forEach(cat => {
                        data.items[cat].forEach(item => {
                            allRiskItems.push({ ...item, category: cat });
                        });
                    });

                    // Update Metrics
                    const criticalCount = allRiskItems.filter(i => i.risk_color === 'red').length;
                    document.getElementById('stat-high-risk').innerText = criticalCount;
                    document.getElementById('stat-total').innerText = allRiskItems.length;

                    // Render All Components
                    renderMapMarkers(data.top_chokepoints);
                    renderMiniChart(data.industry_risks);
                    renderFeed(allRiskItems);
                    renderTicker(allRiskItems);
                })
                .catch(err => {
                    console.error("Data Load Error:", err);
                    document.getElementById('feed-list').innerHTML = `
                        <div style="padding:20px; color:#ff2a6d; text-align:center;">
                            <strong>âš  OFFLINE MODE</strong><br>
                            <span style="font-size:11px; color:#666">Unable to retrieve satellite feed. Ensure 'outputs/dashboard_data.json' exists.</span>
                        </div>`;
                });
        });

        // --- 3. RENDER FUNCTIONS ---

        function renderMapMarkers(chokepoints) {
            if (!chokepoints) return;
            chokepoints.forEach(cp => {
                const coords = chokepointCoords[cp.name];
                if (coords) {
                    // Dynamic Sizing & Coloring
                    let color = cp.score >= 3.5 ? '#ff2a6d' : (cp.score >= 2.5 ? '#ffcc00' : '#00f2ff');
                    let radius = cp.score * 4; // Scale size by risk
                    
                    L.circleMarker(coords, {
                        color: color, fillColor: color, fillOpacity: 0.6, radius: radius, weight: 1
                    }).addTo(map)
                    .bindPopup(`
                        <div style="font-family:'Space Grotesk'; font-size:12px;">
                            <strong style="color:${color}">${cp.name.toUpperCase()}</strong><br>
                            RISK SCORE: <b>${cp.score}</b>
                        </div>
                    `);
                }
            });
        }

        function renderFeed(items) {
            const container = document.getElementById('feed-list');
            container.innerHTML = "";
            
            if (items.length === 0) {
                container.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>No signals detected.</div>";
                return;
            }

            // Sort by Risk (High to Low)
            items.sort((a, b) => b.risk_score - a.risk_score);

            items.forEach(item => {
                // Determine Styles
                let borderColor = '#2a2f3a';
                let badgeColor = '#94a3b8';
                let badgeBg = 'rgba(148, 163, 184, 0.1)';

                if (item.risk_color === 'red') {
                    borderColor = 'var(--alert)';
                    badgeColor = 'var(--alert)';
                    badgeBg = 'rgba(255, 42, 109, 0.1)';
                } else if (item.risk_color === 'yellow') {
                    borderColor = 'var(--warn)';
                    badgeColor = 'var(--warn)';
                    badgeBg = 'rgba(255, 204, 0, 0.1)';
                }

                container.innerHTML += `
                    <div class="intel-card" style="border-left: 3px solid ${borderColor}">
                        <div class="card-meta">
                            <span class="risk-badge" style="color:${badgeColor}; background:${badgeBg}">${item.category}</span>
                            <span>${item.published.substring(5, 16)}</span>
                        </div>
                        <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                        <div class="card-snippet">${item.summary}</div>
                    </div>
                `;
            });
        }

        function renderMiniChart(industries) {
            if (!industries) return;
            const ctx = document.getElementById('miniChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: industries.map(i => i.name.substring(0,3)), // Short labels
                    datasets: [{
                        data: industries.map(i => i.score),
                        backgroundColor: industries.map(i => i.score > 3 ? '#ff2a6d' : '#00f2ff'),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#666', font: {size: 9} } },
                        y: { display: false, min: 0, max: 5 }
                    }
                }
            });
        }

        function renderTicker(items) {
            const ticker = document.getElementById('ticker-content');
            let html = "";
            items.slice(0, 10).forEach(item => {
                let color = item.risk_color === 'red' ? '#ff2a6d' : '#fff';
                html += `<div class="ticker-item" style="color:${color}">/// ${item.title} [RISK: ${item.risk_score}]</div>`;
            });
            // Duplicate for smooth loop
            ticker.innerHTML = html + html + html; 
        }

        // --- 4. FILTER & SEARCH LOGIC ---
        
        function filterData(category) {
            // Update Buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (category === 'ALL') {
                renderFeed(allRiskItems);
            } else {
                const filtered = allRiskItems.filter(i => i.category === category);
                renderFeed(filtered);
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allRiskItems.filter(item => 
                item.title.toLowerCase().includes(query) || 
                item.summary.toLowerCase().includes(query)
            );
            renderFeed(filtered);
        }

    </script>
</body>
</html>
